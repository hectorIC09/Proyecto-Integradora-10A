<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Alumno</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body style="text-align:center; padding-top: 50px; font-family: sans-serif;">

    <h1>Bienvenido <span id="nombreAlumno"></span></h1>
    <p>Matr√≠cula: <strong id="matriculaAlumno"></strong></p>
    
    <div style="margin-top: 30px;">
        <button id="btnGPS" style="background: #28a745; color: white; padding: 15px 30px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer;">
            üìç ACTIVAR UBICACI√ìN
        </button>
        <p id="status" style="margin-top: 15px; color: #666;"></p>
    </div>

    <script>
        // 1. Recuperar sesi√≥n o par√°metros de URL (si viene del correo)
        const params = new URLSearchParams(window.location.search);
        let session = JSON.parse(localStorage.getItem('alumno'));
        
        // Si viene del correo (?matricula=XYZ), creamos una sesi√≥n temporal
        if (!session && params.get('matricula')) {
            session = { matricula: params.get('matricula'), nombre: 'Alumno' };
            localStorage.setItem('alumno', JSON.stringify(session));
        }

        if (!session) {
            window.location.href = '/login-alumno.html';
        }

        document.getElementById('nombreAlumno').innerText = session.nombre;
        document.getElementById('matriculaAlumno').innerText = session.matricula;

        // 2. L√≥gica de Geolocalizaci√≥n
        const btn = document.getElementById('btnGPS');
        const status = document.getElementById('status');

        btn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                status.innerText = "Tu navegador no soporta GPS.";
                return;
            }

            status.innerText = "üìç Obteniendo ubicaci√≥n...";

            // Usamos watchPosition para enviar la ubicaci√≥n continuamente si se mueve
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                
                status.innerText = "üì° Enviando datos...";

                try {
                    const res = await fetch('/api/alumnos/ubicacion', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            matricula: session.matricula, 
                            lat: latitude, 
                            lng: longitude 
                        })
                    });

                    if (res.ok) {
                        status.innerText = `‚úÖ Ubicaci√≥n enviada: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                        status.style.color = "green";
                    } else {
                        status.innerText = "‚ùå Error al guardar en el servidor";
                    }
                } catch (e) {
                    console.error(e);
                    status.innerText = "‚ùå Error de conexi√≥n";
                }
            }, (err) => {
                status.innerText = "‚ùå Acceso a ubicaci√≥n denegado. Por favor permite el acceso.";
                status.style.color = "red";
            }, { enableHighAccuracy: true });
        });
    </script>
</body>
</html>